<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìƒì„¸í˜ì´ì§€</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.17.2/dist/sweetalert2.all.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.17.2/dist/sweetalert2.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      font-weight: 700 !important;
      font-style: normal !important;
    }

    .detail-body {
      background-color: ivory;
    }

    .detail-body .profile-box {
      border: 1px solid black;
      padding: 15px;
      border-radius: 10px;
    }

    .detail-body .profile-box .wrapper {
      display: flex;
      flex-direction: row;
      justify-content: center;
      padding: 30px;
      gap: 20px;
      align-items: stretch;
    }

    .wrapper .profile-section {
      display: flex;
      margin: 20px 0;
      gap: 20px;
    }

    .wrapper .text-section {
      padding-top: 20px;
    }

    .wrapper .profile-section .profile-img-box {
      width: 150px;
      height: 150px;
      display: flex;
      margin-right: 20px;
      border: 1px solid white;
      border-radius: 10px;
    }

    .wrapper .profile-section .profile-img-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 10px;
    }

    .profile-info .info {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 8px 20px;
      font-size: 16px;
      word-break: break-word;
      /*ê¸´ í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ì²˜ë¦¬*/
    }


    .profile-info .input-list {
      font-weight: bold;
    }

    /*ë³‘ì•„ë¦¬ í¬ê¸° ê°ì†Œ */
    .chick {
      font-size: 20px;
    }

    /*ë³‘ì•„ë¦¬ í›„ë²„ ì¶”ê°€ */
    .chick {
      display: inline-block;
      transition: transform 0.3s ease-in-out;
    }

    .chick:hover {
      transform: rotate(15deg) scale(1.2);
    }

    /* ì£¼ì„ ì‚¬ì´ë¥¼ ë³µì‚¬*/
    #detail-title {
      text-align: center;
      font-size: 20px;
    }


    /* ëŒ“ê¸€ ì„¹ì…˜*/

    /* ëŒ“ê¸€ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
    .container {
      background-color: white;
    }

    .card {
      font-family: 'Noto Sans KR', sans-serif;
      font-weight: 700 !important;
      font-style: normal;
      /* ëª…ì‹œì ìœ¼ë¡œ ì§€ì • */
      border: 1px solid black !important;
      /* Bootstrap ê¸°ë³¸ í…Œë‘ë¦¬ ë®ì–´ì“°ê¸° */
      border-radius: 10px;
      padding: 20px;
      /* í”„ë¡œí•„ê³¼ íŒ¨ë”© ë§ì¶¤ */
      background-color: ivory !important;
      /* ë°°ê²½ìƒ‰ ì„¤ì • */
      color: black;
      margin: 0 auto;
      /* ì¤‘ì•™ ì •ë ¬ */
      width: 100%;
      /* ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œ ê½‰ ì±„ì›€ */
      max-width: 100%;
      /* ì»¨í…Œì´ë„ˆ ë„ˆë¹„ ì´ˆê³¼ ë°©ì§€ */
    }

    .form-group {
      width: 100%;
      margin-bottom: 10px;
    }

    .form-group label {
      display: block;
      font-weight: bold;
      margin-bottom: 8px;
      color: black;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #444;
      background-color: white;
      color: black;
      border-radius: 5px;
    }

    .btn-location {
      width: 100%;
      display: flex;
      justify-content: flex-end;
    }

    .btn-submit {
      width: 100px;
      padding: 12px;
      border: 1px solid white;
      background-color: rgb(123, 89, 45);
      color: white;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-submit:hover {
      background-color: black;
      color: white;
    }

    .commentBox {
      background-color: white;
      width: 100%;
      margin-top: 40px;
      border: 1px solid rgb(171, 171, 171);
      border-radius: 5px;
      padding: 15px;
    }

    .time {
      font-size: small;
      color: gray;
    }

    .pagination {
      margin-top: 5%;
      display: flex;
      justify-content: center;
    }

    .page-link {
      color: rgb(123, 89, 45);
    }

    .comment-submit {
      #submitBtn {
        background-color: rgb(123, 89, 45);
        color: white;
        border: none;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        border-radius: 5px;
      }

    }



    /* .commentBox {
                background-color: white;
                width: 100%;
                margin-top: 40px;
                border: 1px solid rgb(171, 171, 171);
                border-radius: 5px;
                margin-left: auto;
                margin-right: auto;
            }
    
            .time {
                font-size: small;
                color: gray;
            }
    
            .pagination {
                margin-top: 5%;
                display: flex;
                justify-content: center;
            } */
    .floating-chick {
      position: fixed;
      bottom: 20px;
      /* í•˜ë‹¨ ì—¬ë°± */
      right: 20px;
      /* ìš°ì¸¡ ì—¬ë°± */
      width: 120px;
      z-index: 9999;
      /* ë‹¤ë¥¸ ìš”ì†Œë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ */
      pointer-events: auto;
      /* í´ë¦­ ë°©í•´í•˜ì§€ ì•Šë„ë¡ */
      opacity: 0.95;
      transition: transform 0.3s ease;
    }

    /* í˜¸ë²„ ì‹œ ì‚´ì§ ì»¤ì§ì§ */
    .floating-chick:hover {
      transform: scale(1.2);
    }
  </style>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ëŒ“ê¸€</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

  <script type="module">
    // Firebase SDK ë¼ì´ë¸ŒëŸ¬ë¦¬ ê°€ì ¸ì˜¤ê¸°
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { collection, addDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { query, where } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"; // serverTimestamp import ì¶”ê°€


    // Firebase êµ¬ì„± ì •ë³´ ì„¤ì •
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyCVPjHmumz5vE8GeGMFX9Z1Kgkc6Br9tpM",
      authDomain: "sparta-ec005.firebaseapp.com",
      projectId: "sparta-ec005",
      storageBucket: "sparta-ec005.firebasestorage.app",
      messagingSenderId: "164807435795",
      appId: "1:164807435795:web:cf27e6ffe27d5bc05901e6"
    };


    // Firebase ì¸ìŠ¤í„´ìŠ¤ ì´ˆê¸°í™”
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // URLì—ì„œ name íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸°
    const urlParams = new URLSearchParams(window.location.search);
    const idParam = urlParams.get("id");

    async function getMemberDetail(id) {
      const docRef = doc(db, "Intro", id);
      const docSnap = await getDoc(docRef);

      if (docSnap.exists()) {
        const data = docSnap.data();

        // ë°ì´í„° ë°”ì¸ë”©
        document.querySelector(".profile-img-box img").src = data.image;
        document.getElementById("name").innerText = data.name;
        const nowAge = new Date().getFullYear() - new Date(data.birth).getFullYear();
        document.getElementById("age").innerText = nowAge;
        document.getElementById("hobby").innerText = data.hobby;
        document.getElementById("blogLink").innerText = data.blogLink;
        document.getElementById("introText").innerText = data.intro;
        document.getElementById("tmiText").innerText = data.tmi;

      } else {
        alert("í•´ë‹¹ íŒ€ì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      }
    }

    getMemberDetail(idParam);

    //ëŒ“ê¸€ ë“±ë¡ ê°€ëŠ¥
    let commentsData = []
    let pageNumber = 1;

    //ë²„íŠ¼ í´ë¦­ ì‹œ
    $("#comment-submit").click(async function () {
      let userId = $('#user-id').val();
      let comment = $('#comment-content').val();

      if (userId.trim() === "" || comment.trim() === "") {
        Swal.fire({
          title: "ì…ë ¥ê°’ì´ ì´ìƒí•´ìš”",
          text: "ì´ë¦„ê³¼ ë‚´ìš©ì„ ë˜‘ë°”ë¡œì¢€ ì ì–´ì£¼ì„¸ìš”",
          icon: "warning"
        });
        return;
      }

      let doc = {
        userId: userId,
        comment: comment,
        memberId: idParam,
        timestamp: serverTimestamp()
      };

      await Swal.fire({
        title: "ì €ì¥í• ë˜ìš”?",
        icon: "question",
        showCancelButton: true,
        confirmButtonText: "ì €ì¥í•´ìš”",
        cancelButtonText: "ë‹¤ì‹œí• ë˜ìš”"
      }).then(async (result) => {
        if (result.isConfirmed) {
          // Firebaseì— ëŒ“ê¸€ ì €ì¥
          await addDoc(collection(db, "comments"), doc);
          Swal.fire("ì €ì¥í–ˆì–´ìš”!", "", "success");
          $('#user-id').val("");
          $('#comment-content').val("");

          // ëŒ“ê¸€ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
          getCommentsCount();
          getComments();
        }
      });
    });

    // ë°©ëª…ë¡ ê°œìˆ˜
    async function getCommentsCount() {
      const querySnapshot = await getDocs(query(collection(db, "comments"), where("memberId", "==", idParam)));
      const count = querySnapshot.size;  // ì»¬ë ‰ì…˜ì˜ ë¬¸ì„œ ìˆ˜ë¥¼ ê°€ì ¸ì˜´
      $("#message").text(count);  // ë°©ëª…ë¡ ìˆ˜ í‘œì‹œ
    }

    // ëŒ“ê¸€ ë°ë² ì—ì„œ ë¡œë“œ
    async function getComments() {
      const querySnapshot = await getDocs(query(collection(db, "comments"), where("memberId", "==", idParam)));
      commentsData = []

      querySnapshot.forEach((doc) => {
        let data = doc.data();
        commentsData.push({
          ...data,
          id: doc.id
        });
      });

      //ì‹œê°„ ìˆœ ë‚´ë¦¼ì°¨ìˆœ
      commentsData.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);

      displayCommentsData();
      pagination_add();
    }

    // ë°©ëª…ë¡ ì¶œë ¥
    function displayCommentsData() {
      let commentsList = commentsData.slice((pageNumber - 1) * 5, pageNumber * 5);
      $("#commentsList .commentBox").remove();// ê¸°ì¡´ì˜ ë°©ëª…ë¡ ì—†ì• ê¸°_ë‹¤ì‹œ ì¶œë ¥í• êº¼ë‹ˆê¹Œ

      let html = "";
      commentsList.forEach((data) => {
        html += `
                <div class = "commentBox">
                        <strong>${data.userId}</strong><br/>
                        <p>${data.comment}</p>
                        <p class="time">${data.timestamp.toDate().toLocaleString()}</p>
                </div>
                `;
      });
      $("#commentsList").append(html);
    }


    // í˜ì´ì§€ë„¤ì´ì…˜ ì¶”ê°€
    function pagination_add() {

      const pages = Math.ceil(commentsData.length / 5);
      let html = "";

      // í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ì¶”ê°€
      for (let i = 0; i < pages; i++) {
        html += `
                      <li class="page-item">
                          <a class="page-link" href="#">${i + 1}</a>
                      </li>
                  `;
      }

      $(".pagination").html(html);  // í˜ì´ì§€ë„¤ì´ì…˜ì„ ì¶”ê°€
    }

    // í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ í´ë¦­, ë°©ëª…ë¡ ì¶œë ¥
    $(document).on('click', '.page-link', function (event) {
      event.preventDefault();
      console.log("ã…ã…");
      pageNumber = parseInt($(this).text());  // í´ë¦­í•œ í˜ì´ì§€ ë²ˆí˜¸
      displayCommentsData();  // í•´ë‹¹ í˜ì´ì§€ì˜ ë°©ëª…ë¡ ì¶œë ¥
    });

    $(document).ready(function () {
      // ë°ë²  ë¡œë“œ
      getComments();
      getCommentsCount();
    }); 
  </script>
</head>

<body>
  <div class="container mt-3 mb-3">
    <div class="detail-body">
      <div class="profile-box">
        <p id="detail-title" style="font-size: 30px;">ğŸ£2gether MemberğŸ£</p>
        <hr>
        <div class="wrapper">
          <div class="profile-section">
            <div>
              <dd id="introText" class="input-list" style="
                            position: absolute;
                            top: 115px; /* ì›í•˜ëŠ” ìœ„ì¹˜ ì¡°ì ˆ */
                            left: 50%;
                            transform: translateX(-50%);
                            text-align: center;
                            width: 100%;
                            z-index: 10;
                            font-size: 20px;"></dd>
            </div>
            <div class="profile-img-box">
              <img src="default-image" />
            </div>
            <div class="profile-info">
              <dl class="info">
                <dt>ì´ë¦„ : </dt>
                <dd id="name" class="input-list"></dd>
                <dt>ìƒë…„ì›”ì¼ : </dt>
                <dd id="age" class="input-list"></dd>
                <dt>ì·¨ë¯¸ : </dt>
                <dd id="hobby" class="input-list"></dd>
                <dt>ë¸”ë¡œê·¸ ë§í¬ : </dt>
                <dd id="blogLink" class="input-list"></dd>
                <dt>TMI : </dt>
                <dd id="tmiText" class="input-list"></dd>
              </dl>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <h5 class="card-header">ëŒ“ê¸€</h5>
      <div class="card-body">
        <div class="form-floating mb-3" style="max-width: 800px;">


          <div class="form-floating mb-3">
            <input type="text" class="form-control" id="user-id" placeholder="ì•„ì´ë””">
            <label for="user-id">ì•„ì´ë””</label>
          </div>

          <div class="form-floating mb-3">
            <input class="form-control" id="comment-content" placeholder="ëŒ“ê¸€" style="height: 100px;"></input>
            <label for="comment-content">ëŒ“ê¸€</label>
          </div>
          <div class="btn-location"><button id="comment-submit" type="button" class="btn-submit">ë“±ë¡í•˜ê¸°</button>
          </div>
        </div>
        <hr>
        <p>ëŒ“ê¸€ ìˆ˜: <span id="message">0</span></p>
        <div id="commentsList" style="margin-top: 30px;"></div>
      </div>
      <div class="pagination-location">
        <nav aria-label="Page navigation example">
          <ul class="pagination">
          </ul>
        </nav>
      </div>
    </div>
  </div>

  <!-- ë³‘ì•„ë¦¬ ì´ë¯¸ì§€ ìš°ì¸¡ í•˜ë‹¨ ê³ ì • -->
  <a href="main.html">
    <img id="chickBtn" src="images/chickTogether.png" alt="íˆ¬ê²Œë” ë³‘ì•„ë¦¬" class="floating-chick">
  </a>
  <script>
    $(document).ready(function () {
      $("#chickBtn").click(function () {
        window.location.href = "index.html";
      });
    });
  </script>

</body>

</html>